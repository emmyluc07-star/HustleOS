<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" sizes="57x57" href="apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#00ff41">
    <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
    <meta name="theme-color" content="#00ff41">
    <title>HUSTLE_OS v5.0 // TEMPLATE_MODE</title>
    <style>
        /* --- KEEP YOUR EXISTING CSS (I added Edit Button styles below) --- */
        :root { --bg-color: #000; --neon-green: #00ff41; --neon-red: #ff003c; --neon-blue: #00f3ff; --font-main: 'Courier New', monospace; }
        body { background: var(--bg-color); color: #fff; font-family: var(--font-main); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 30px 30px; }
        .red-alert-mode { 
            animation: flash-red 0.6s infinite, shake 0.1s infinite;
            border: 4px solid var(--neon-red);
            box-shadow: inset 0 0 50px rgba(255, 0, 60, 0.3), 0 0 30px rgba(255, 0, 60, 0.8);
        }
        @keyframes flash-red { 
            0% { border-color: var(--neon-red); box-shadow: inset 0 0 50px rgba(255, 0, 60, 0.3), 0 0 30px rgba(255, 0, 60, 0.8); } 
            25% { border-color: #ff6666; box-shadow: inset 0 0 80px rgba(255, 0, 60, 0.5), 0 0 50px rgba(255, 0, 60, 1); } 
            50% { border-color: #ff0000; box-shadow: inset 0 0 100px rgba(255, 0, 60, 0.7), 0 0 70px rgba(255, 0, 60, 1); }
            75% { border-color: #ff6666; box-shadow: inset 0 0 80px rgba(255, 0, 60, 0.5), 0 0 50px rgba(255, 0, 60, 1); }
            100% { border-color: var(--neon-red); box-shadow: inset 0 0 50px rgba(255, 0, 60, 0.3), 0 0 30px rgba(255, 0, 60, 0.8); } 
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0) translateY(0); }
            10% { transform: translateX(-2px) translateY(-1px); }
            20% { transform: translateX(2px) translateY(1px); }
            30% { transform: translateX(-1px) translateY(-2px); }
            40% { transform: translateX(1px) translateY(2px); }
            50% { transform: translateX(-2px) translateY(1px); }
            60% { transform: translateX(2px) translateY(-1px); }
            70% { transform: translateX(-1px) translateY(2px); }
            80% { transform: translateX(1px) translateY(-2px); }
            90% { transform: translateX(-2px) translateY(-1px); }
        }
        
        .cockpit { background: rgba(10,10,10,0.95); border: 1px solid #333; border-bottom: 2px solid var(--neon-green); padding: 20px; border-radius: 0 0 15px 15px; text-align: center; margin-bottom: 20px; position: relative; }
        
        /* Landscape cockpit layout */
        @media (orientation: landscape) {
            body {
                display: grid;
                grid-template-columns: 350px 1fr;
                grid-template-rows: 1fr 60px;
                gap: 20px;
                padding: 10px;
                height: 100vh;
                overflow: hidden;
            }
            
            .cockpit {
                grid-column: 1;
                grid-row: 1;
                margin-bottom: 0;
                height: fit-content;
            }
            
            .timeline-container {
                grid-column: 2;
                grid-row: 1;
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 10px;
                padding: 0;
                margin-bottom: 0;
                overflow-y: auto;
            }
            
            .bottom-nav {
                grid-column: 1 / -1;
                grid-row: 2;
                position: static;
                margin: 0;
            }
            
            .fab-add {
                bottom: 80px;
                right: 20px;
            }
            
            /* Hide detailed controls in landscape */
            .landscape-hide {
                display: none !important;
            }
            
            /* Compact cockpit for landscape */
            .cockpit .timer-display {
                font-size: 2.5rem;
            }
            
            .task-card {
                margin-bottom: 0;
                min-height: 70px;
            }
        }
        .current-mission { font-size: 1.4rem; font-weight: bold; text-transform: uppercase; margin: 10px 0; }
        .timer-display { font-size: 3.2rem; color: var(--neon-green); font-weight: bold; font-family: monospace; }
        .btn-main { background: transparent; border: 1px solid var(--neon-green); color: var(--neon-green); padding: 10px; width: 100%; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        
        /* TASK LIST STYLES */
        .timeline-container { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .task-card { background: rgba(20,20,20,0.6); border-left: 3px solid #333; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; position: relative; transition: 0.3s; }
        .task-card.active { border-left-color: var(--neon-green); background: linear-gradient(90deg, rgba(0,255,65,0.1), transparent); transform: scale(1.02); }
        
        /* Landscape layout for task cards */
        @media (orientation: landscape) {
            .timeline-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 10px;
                padding: 10px;
            }
            .task-card {
                margin-bottom: 0;
                min-height: 80px;
            }
        }
        
        /* ACTION BUTTONS (EDIT & DELETE) */
        .card-actions { display: flex; gap: 10px; }
        .action-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; opacity: 0.6; color: #fff; }
        .action-icon:hover { opacity: 1; transform: scale(1.1); }
        .btn-edit { color: var(--neon-blue); }
        .btn-del { color: var(--neon-red); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: #111; border: 1px solid var(--neon-blue); padding: 20px; width: 85%; max-width: 350px; }
        .cyber-input { width: 100%; background: #000; border: 1px solid #333; color: #fff;   padding: 10px; margin-bottom: 15px; box-sizing: border-box; }
        .modal-actions { display: flex; gap: 10px; }
        .btn-confirm { background: var(--neon-blue); color: #000; border: none; flex: 1; padding: 10px; font-weight: bold; cursor: pointer; }
        .btn-cancel { border: 1px solid #444; color: #888; background: transparent; flex: 1; padding: 10px; cursor: pointer; }

        .fab-add { position: fixed; bottom: 90px; right: 30px; width: 60px; height: 60px; background: #000; border: 2px solid var(--neon-blue); border-radius: 50%; color: var(--neon-blue); font-size: 2rem; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 50; }
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.95); border-top: 1px solid #333; display: flex; height: 60px; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; cursor: pointer; font-size: 0.7rem; }
        .nav-item.active { color: var(--neon-green); }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }
        
        /* Cockpit Stopwatch Styles */
        .cockpit-stopwatch { 
            background: rgba(10,10,10,0.95); 
            border: 1px solid #333; 
            border-bottom: 2px solid var(--neon-green); 
            padding: 40px; 
            margin: 20px; 
            border-radius: 15px; 
            text-align: center; 
            position: relative;
            background-image: linear-gradient(rgba(0,255,65,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,65,0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .stopwatch-header { 
            position: absolute; 
            top: 10px; 
            left: 15px; 
            font-size: 0.6rem; 
            color: var(--neon-green); 
            font-weight: bold;
        }
        .stopwatch-display-container { 
            margin: 40px 0; 
        }
        .stopwatch-label { 
            color: #888; 
            font-size: 0.8rem; 
            margin-bottom: 10px; 
            font-weight: bold;
        }
        .stopwatch-timer { 
            font-size: 4rem !important; 
            color: var(--neon-green) !important; 
            text-shadow: 0 0 20px rgba(0,255,65,0.5);
        }
        .stopwatch-controls { 
            display: flex; 
            gap: 20px; 
            justify-content: center; 
            margin-top: 30px;
        }
        .stopwatch-btn { 
            padding: 15px 30px; 
            font-weight: bold; 
            text-transform: uppercase; 
            cursor: pointer;
        }
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--neon-red); 
            color: var(--neon-red); 
        }
        .btn-secondary:hover { 
            background: rgba(255,0,60,0.1);
        }
        .stopwatch-grid { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 3px;
        }
        .grid-line { 
            height: 1px; 
            background: var(--neon-green); 
            margin: 1px 0; 
            opacity: 0.3;
        }
    </style>
</head>
<body>

    <div id="addModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--neon-blue); margin-top:0;">MISSION PARAMETERS</h3>
            <input type="hidden" id="editId"> <label style="color:#666; font-size:0.7rem;">MISSION TITLE</label>
            <input type="text" id="taskTitle" class="cyber-input" placeholder="e.g. DEEP WORK">
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label style="color:#666; font-size:0.7rem;">START (24H)</label>
                    <input type="time" id="taskStart" class="cyber-input">
                </div>
                <div style="flex:1">
                    <label style="color:#666; font-size:0.7rem;">END (24H)</label>
                    <input type="time" id="taskEnd" class="cyber-input">
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">CANCEL</button>
                <button class="btn-confirm" onclick="saveTask()">SAVE DATA</button>
            </div>
        </div>
    </div>

    <div class="cockpit">
        <div style="position:absolute; top:10px; left:10px; font-size:0.6rem; color:#555;">SYS.V5.0 // ONLINE</div>
        <button onclick="resetTemplate()" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#555; cursor:pointer;">‚Ü∫ RESET</button>
        
        <!-- Day Selector -->
        <div class="day-selector" style="position:absolute; top:40px; left:10px; display:flex; gap:5px;">
            <div style="color:#666; font-size:0.6rem; margin-right:5px;">DAY:</div>
            <select id="daySelect" onchange="switchToDay(this.value)" style="background:#000; border:1px solid #333; color:#fff; padding:2px; font-size:0.6rem;">
                <option value="Monday">MON</option>
                <option value="Tuesday">TUE</option>
                <option value="Wednesday">WED</option>
                <option value="Thursday">THU</option>
                <option value="Friday">FRI</option>
                <option value="Saturday">SAT</option>
                <option value="Sunday">SUN</option>
            </select>
        </div>
        
        <div id="mini-task" class="mini-task-card" style="display:none; position:absolute; top:40px; right:10px; background:#000; border:2px solid var(--neon-green); padding:8px; border-radius:3px; font-size:0.6rem; width:120px; box-shadow:0 0 10px rgba(0,255,65,0.3);">
            <div style="color:var(--neon-green); font-weight:bold; font-size:0.5rem;">PRIORITY</div>
            <div id="mini-task-title" style="font-size:0.6rem; margin:2px 0;">LOADING...</div>
            <div id="mini-task-timer" style="color:var(--neon-green); font-weight:bold; font-size:0.7rem;">00:00:00</div>
        </div>
        
        <div style="color:#888; font-size:0.7rem; margin-top:15px;">CURRENT OBJECTIVE</div>
        <div class="current-mission">LOADING...</div>
        <div class="timer-display">00:00:00</div>
        
        <button id="main-btn" class="btn-main" onclick="handleSystemClick()">INITIALIZE SYSTEM</button>
        
        <!-- Alarm Sound Selector -->
        <div class="landscape-hide" style="margin-top:10px; display:flex; align-items:center; gap:10px;">
            <label style="color:#666; font-size:0.7rem;">ALARM:</label>
            <select id="alarmSelect" onchange="saveAlarmSound()" style="background:#000; border:1px solid #333; color:#fff; padding:5px; flex:1;">
                <option value="classic">‚è∞ CLASSIC BELL</option>
                <option value="digital">üì± DIGITAL BEEP</option>
                <option value="rooster">üêì ROOSTER</option>
                <option value="buzzer">‚ö° BUZZER</option>
                <option value="gentle">üåÖ GENTLE WAKE</option>
                <option value="urgent">üö® URGENT</option>
                <option value="chimes">üéµ WIND CHIMES</option>
                <option value="radio">üìª RADIO STATIC</option>
                <option value="beeping">üì¢ FAST BEEPING</option>
                <option value="oldphone">‚òéÔ∏è OLD PHONE</option>
                <option value="siren">üö® SIREN (ORIGINAL)</option>
                <option value="beep">üì¢ BEEP (ORIGINAL)</option>
                <option value="pulse">‚ö° PULSE (ORIGINAL)</option>
                <option value="horn">üìØ HORN (ORIGINAL)</option>
                <option value="chime">üîî CHIME (ORIGINAL)</option>
            </select>
        </div>
        
        <button class="landscape-hide" onclick="testAlarm()" style="margin-top:10px; padding:5px; background:rgba(255,0,60,0.1); border:1px solid var(--neon-red); color:var(--neon-red); width:100%; cursor:pointer;">üö® TEST ALARM</button>
        
        <!-- Quick Alarm Section -->
        <div class="landscape-hide" style="margin-top:15px; padding:10px; background:rgba(0,255,255,0.1); border:1px solid var(--neon-blue); border-radius:5px;">
            <div style="color:var(--neon-blue); font-weight:bold; font-size:0.8rem; margin-bottom:10px;">‚è∞ QUICK ALARM</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="time" id="quickAlarmTime" style="background:#000; border:1px solid #333; color:#fff; padding:5px; flex:1;">
                <button onclick="setQuickAlarm()" style="background:var(--neon-blue); color:#000; border:none; padding:5px 10px; cursor:pointer; font-weight:bold;">SET</button>
            </div>
            <div id="quickAlarmsList" style="margin-top:10px;"></div>
        </div>
    </div>

    <div class="timeline-container"></div>
    <div class="fab-add" onclick="openModal()">+</div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchView('alarms')">
            <div class="nav-icon">‚è∞</div>
            <div>ALARMS</div>
        </div>
        <div class="nav-item" onclick="switchView('stopwatch')">
            <div class="nav-icon">‚è±Ô∏è</div>
            <div>STOPWATCH</div>
        </div>
        <div class="nav-item" onclick="switchView('settings')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>SETTINGS</div>
        </div>
    </div>

    <script type="module" src="https://unpkg.com/@capacitor/core@6/dist/capacitor.js"></script>
    <script src="./native-integration.js"></script>
    <script>
        // --- INTELLIGENT SCHEDULES DATA STRUCTURE ---
        const TEMPLATE_SCHEDULES = {
            Monday: [
                { id: 'm1', title: 'WAKE & PRAY', start: '06:00', end: '07:00' },
                { id: 'm2', title: 'TRANSIT', start: '07:00', end: '08:00' },
                { id: 'm3', title: 'PRINT BUSINESS', start: '08:00', end: '16:00' },
                { id: 'm4', title: 'WORK', start: '16:00', end: '23:00' },
                { id: 'm5', title: 'TRANSIT HOME', start: '23:00', end: '00:00' },
                { id: 'm6', title: 'ACADEMIC STUDY', start: '00:00', end: '01:30' },
                { id: 'm7', title: 'TRADING & DEV', start: '01:30', end: '03:00' },
                { id: 'm8', title: 'SLEEP (3HRS)', start: '03:00', end: '06:00' }
            ],
            Tuesday: [
                { id: 't1', title: 'WAKE & PRAY', start: '06:00', end: '07:00' },
                { id: 't2', title: 'TRANSIT', start: '07:00', end: '08:00' },
                { id: 't3', title: 'PRINT BUSINESS', start: '08:00', end: '16:00' },
                { id: 't4', title: 'WORK', start: '16:00', end: '23:00' },
                { id: 't5', title: 'TRANSIT HOME', start: '23:00', end: '00:00' },
                { id: 't6', title: 'ACADEMIC STUDY', start: '00:00', end: '01:30' },
                { id: 't7', title: 'TRADING & DEV', start: '01:30', end: '03:00' },
                { id: 't8', title: 'SLEEP (3HRS)', start: '03:00', end: '06:00' }
            ],
            Wednesday: [
                { id: 'w1', title: 'WAKE & PRAY', start: '06:00', end: '07:00' },
                { id: 'w2', title: 'TRANSIT', start: '07:00', end: '08:00' },
                { id: 'w3', title: 'PRINT BUSINESS', start: '08:00', end: '16:00' },
                { id: 'w4', title: 'WORK', start: '16:00', end: '23:00' },
                { id: 'w5', title: 'TRANSIT HOME', start: '23:00', end: '00:00' },
                { id: 'w6', title: 'ACADEMIC STUDY', start: '00:00', end: '01:30' },
                { id: 'w7', title: 'TRADING & DEV', start: '01:30', end: '03:00' },
                { id: 'w8', title: 'SLEEP (3HRS)', start: '03:00', end: '06:00' }
            ],
            Thursday: [
                { id: 'th1', title: 'WAKE & PRAY', start: '06:00', end: '07:00' },
                { id: 'th2', title: 'TRANSIT', start: '07:00', end: '08:00' },
                { id: 'th3', title: 'PRINT BUSINESS', start: '08:00', end: '16:00' },
                { id: 'th4', title: 'WORK', start: '16:00', end: '23:00' },
                { id: 'th5', title: 'TRANSIT HOME', start: '23:00', end: '00:00' },
                { id: 'th6', title: 'ACADEMIC STUDY', start: '00:00', end: '01:30' },
                { id: 'th7', title: 'TRADING & DEV', start: '01:30', end: '03:00' },
                { id: 'th8', title: 'SLEEP (3HRS)', start: '03:00', end: '06:00' }
            ],
            Friday: [
                { id: 'f1', title: 'WAKE & PRAY', start: '06:00', end: '07:00' },
                { id: 'f2', title: 'TRANSIT', start: '07:00', end: '08:00' },
                { id: 'f3', title: 'PRINT BUSINESS', start: '08:00', end: '16:00' },
                { id: 'f4', title: 'WORK', start: '16:00', end: '23:00' },
                { id: 'f5', title: 'TRANSIT HOME', start: '23:00', end: '00:00' },
                { id: 'f6', title: 'ACADEMIC STUDY', start: '00:00', end: '01:30' },
                { id: 'f7', title: 'TRADING & DEV', start: '01:30', end: '03:00' },
                { id: 'f8', title: 'SLEEP (3HRS)', start: '03:00', end: '06:00' }
            ],
            Saturday: [
                { id: 's1', title: 'WAKE & PRAY', start: '08:00', end: '09:00' },
                { id: 's2', title: 'WEEKEND PROJECT', start: '09:00', end: '12:00' },
                { id: 's3', title: 'FAMILY TIME', start: '12:00', end: '18:00' },
                { id: 's4', title: 'PERSONAL DEV', start: '18:00', end: '22:00' },
                { id: 's5', title: 'SLEEP', start: '22:00', end: '08:00' }
            ],
            Sunday: [
                { id: 'su1', title: 'WAKE & PRAY', start: '08:00', end: '09:00' },
                { id: 'su2', title: 'PLANNING', start: '09:00', end: '11:00' },
                { id: 'su3', title: 'REST & REFLECT', start: '11:00', end: '15:00' },
                { id: 'su4', title: 'PREP FOR WEEK', start: '15:00', end: '20:00' },
                { id: 'su5', title: 'SLEEP', start: '20:00', end: '08:00' }
            ]
        };

        // Load saved schedules OR use Template
        let schedules = JSON.parse(localStorage.getItem('userSchedules')) || TEMPLATE_SCHEDULES;
        let currentDay = getCurrentDayName();
        let selectedDay = currentDay; // For editing
        let schedule = schedules[currentDay] || [];
        
        // Initialize pinned tasks and quick alarms
        let pinnedTasks = JSON.parse(localStorage.getItem('pinnedTasks')) || [];
        let quickAlarms = JSON.parse(localStorage.getItem('quickAlarms')) || [];
        
        // Screen wake setting
        let screenWakeEnabled = localStorage.getItem('screenWakeEnabled') !== 'false'; // Default true
        
        function getCurrentDayName() {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date().getDay()];
        }
        
        function switchToDay(dayName) {
            selectedDay = dayName;
            schedule = schedules[dayName] || [];
            if (currentView === 'alarms') {
                updateDisplay();
            }
        }
        // --- GLOBAL ALARM SYSTEM (Runs regardless of tab) ---
        window.globalAlarmSystem = {
            armed: localStorage.getItem('systemArmed') === 'true' || false,
            triggered: false,
            
            checkAlarms: async function() {
                if (!this.armed) return;
                
                // Get current day's schedule
                const today = getCurrentDayName();
                const todaySchedule = schedules[today] || [];
                
                const tasks = this.findCurrentTask(todaySchedule);
                const mainTask = tasks.main;
                const miniTask = tasks.mini;
                
                // Check mini task first (priority)
                if (miniTask) {
                    const miniSec = this.getSecondsLeft(miniTask.end);
                    if (miniSec <= 0 && miniSec > -10 && miniTask.title !== "IDLE MODE") {
                        if (!this.triggered) {
                            await this.triggerAlarm(miniTask.title);
                        }
                    }
                } else {
                    // Check main task
                    const sec = this.getSecondsLeft(mainTask.end);
                    if (sec <= 0 && sec > -10 && mainTask.title !== "IDLE MODE") {
                        if (!this.triggered) {
                            await this.triggerAlarm(mainTask.title);
                        }
                    }
                }
                
                // Check quick alarms
                await this.checkQuickAlarms();
            },
            
            triggerAlarm: async function(taskTitle) {
                console.log('üö® GLOBAL ALARM TRIGGERED:', taskTitle);
                this.triggered = true;
                
                // Play sound immediately (decoupled from notifications)
                playSynthAlarm();
                
                // Visual effects
                document.body.classList.add('red-alert-mode');
                const btn = document.getElementById('main-btn');
                if (btn) {
                    btn.innerText = "‚ö† SILENCE ALARM ‚ö†";
                    btn.style.borderColor = "var(--neon-red)";
                    btn.style.color = "var(--neon-red)";
                }
                
                // Handle screen wake based on user setting
                if (screenWakeEnabled && window.nativeIntegration) {
                    await window.nativeIntegration.wakeScreen(true);
                }
                
                // Send notification (don't wait for it)
                setTimeout(() => {
                    sendNotification('üö® HUSTLE OS ALARM', `Task ended: ${taskTitle}`);
                }, 100);
            },
            
            silenceAlarm: function() {
                this.triggered = false;
                stopSynthAlarm();
                document.body.classList.remove('red-alert-mode');
                const btn = document.getElementById('main-btn');
                if (btn) {
                    btn.innerText = "SYSTEM ARMED";
                    btn.style.color = "var(--neon-green)";
                    btn.style.borderColor = "var(--neon-green)";
                    btn.style.background = "rgba(0,255,65,0.1)";
                }
            },
            
            // Fixed midnight bug with proper 24-hour handling
            getSecondsLeft: function(endStr) {
                if (endStr === "00:00") return 0;
                
                const now = new Date();
                const [h, m] = endStr.split(':').map(Number);
                
                // Create target time for today
                let target = new Date(now);
                target.setHours(h, m, 0, 0);
                
                // If target is in the past, it's tomorrow
                if (target <= now) {
                    target.setDate(target.getDate() + 1);
                }
                
                return Math.floor((target - now) / 1000);
            },
            
            findCurrentTask: function(daySchedule) {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                let validCandidates = [];

                for (let t of daySchedule) {
                    let s = this.parseTime(t.start);
                    let e = this.parseTime(t.end);
                    
                    // Handle midnight crossover (e.g., 23:00 to 01:00)
                    if (e < s) {
                        // Task crosses midnight
                        if (currentMinutes >= s || currentMinutes < e) {
                            validCandidates.push({ task: t, duration: (1440 - s) + e });
                        }
                    } else {
                        // Normal task within same day
                        if (currentMinutes >= s && currentMinutes < e) {
                            validCandidates.push({ task: t, duration: e - s });
                        }
                    }
                }

                if (validCandidates.length === 0) {
                    return { main: { title: "IDLE MODE", start: "00:00", end: "00:00" }, mini: null };
                }

                // Sort by duration (shortest first)
                validCandidates.sort((a, b) => a.duration - b.duration);

                if (validCandidates.length === 1) {
                    return { main: validCandidates[0].task, mini: null };
                } else {
                    return { 
                        mini: validCandidates[0].task, 
                        main: validCandidates[validCandidates.length - 1].task 
                    };
                }
            },
            
            parseTime: function(timeStr) {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            },
            
            checkQuickAlarms: async function() {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                
                for (const alarm of quickAlarms) {
                    if (alarm.time === currentTime && !this.triggered) {
                        console.log('üö® QUICK ALARM TRIGGERED:', alarm.label);
                        await this.triggerAlarm('Quick Alarm');
                        deleteQuickAlarm(alarm.id);
                        break;
                    }
                }
            }
        };
        
        function togglePin(taskId) {
            if (pinnedTasks.includes(taskId)) {
                pinnedTasks = pinnedTasks.filter(id => id !== taskId);
            } else {
                pinnedTasks.push(taskId);
            }
            localStorage.setItem('pinnedTasks', JSON.stringify(pinnedTasks));
            updateDisplay();
        }
        
        // Start global alarm loop (runs every second regardless of tab)
        setInterval(() => {
            window.globalAlarmSystem.checkAlarms();
        }, 1000);
        
        function togglePin(taskId) {
            if (pinnedTasks.includes(taskId)) {
                pinnedTasks = pinnedTasks.filter(id => id !== taskId);
            } else {
                pinnedTasks.push(taskId);
            }
            localStorage.setItem('pinnedTasks', JSON.stringify(pinnedTasks));
            updateDisplay();
        }
        
        // --- STOPWATCH ---
        let stopwatchTime = 0;
        let stopwatchInterval = null;
        let stopwatchRunning = false;
        
        function formatStopwatchTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }
        
        function startStopwatch() {
            if (!stopwatchRunning) {
                stopwatchRunning = true;
                stopwatchInterval = setInterval(() => {
                    stopwatchTime++;
                    document.getElementById('stopwatch-display').innerText = formatStopwatchTime(stopwatchTime);
                }, 1000);
                document.getElementById('stopwatch-btn').innerText = 'PAUSE';
            } else {
                stopwatchRunning = false;
                clearInterval(stopwatchInterval);
                document.getElementById('stopwatch-btn').innerText = 'START';
            }
        }
        
        function resetStopwatch() {
            stopwatchRunning = false;
            clearInterval(stopwatchInterval);
            stopwatchTime = 0;
            document.getElementById('stopwatch-display').innerText = '00:00:00';
            document.getElementById('stopwatch-btn').innerText = 'START';
        }
        
        // --- QUICK ALARMS ---
        function setQuickAlarm() {
            const timeInput = document.getElementById('quickAlarmTime');
            const time = timeInput.value;
            if (!time) return alert('Please select a time');
            
            const alarmId = 'qa_' + Date.now();
            const alarm = {
                id: alarmId,
                time: time,
                label: `Alarm at ${time}`
            };
            
            quickAlarms.push(alarm);
            localStorage.setItem('quickAlarms', JSON.stringify(quickAlarms));
            timeInput.value = '';
            updateQuickAlarmsList();
        }
        
        function deleteQuickAlarm(id) {
            quickAlarms = quickAlarms.filter(a => a.id !== id);
            localStorage.setItem('quickAlarms', JSON.stringify(quickAlarms));
            updateQuickAlarmsList();
        }
        
        function updateQuickAlarmsList() {
            const container = document.getElementById('quickAlarmsList');
            if (!container) return;
            
            if (quickAlarms.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = quickAlarms.map(alarm => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:5px; background:rgba(0,0,0,0.3); margin:2px 0; border-radius:3px;">
                    <span style="font-size:0.8rem;">üîî ${alarm.time}</span>
                    <button onclick="deleteQuickAlarm('${alarm.id}')" style="background:var(--neon-red); color:#000; border:none; padding:2px 6px; cursor:pointer; font-size:0.7rem;">√ó</button>
                </div>
            `).join('');
        }
        
        async function checkQuickAlarms() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            for (const alarm of quickAlarms) {
                if (alarm.time === currentTime && systemArmed && !alarmTriggered) {
                    console.log('üö® QUICK ALARM TRIGGERED:', alarm.label);
                    alarmTriggered = true;
                    playSynthAlarm();
                    
                    // Visual effects
                    document.body.classList.add('red-alert-mode');
                    const btn = document.getElementById('main-btn');
                    btn.innerText = "‚ö† SILENCE ALARM ‚ö†";
                    btn.style.borderColor = "var(--neon-red)";
                    btn.style.color = "var(--neon-red)";
                    
                    // Send notification properly
                    await sendNotification('üö® QUICK ALARM', alarm.label);
                    
                    // Auto-remove the alarm after triggering
                    deleteQuickAlarm(alarm.id);
                    break; // Only trigger one alarm at a time
                }
            }
        }
        
        // Settings page functions
        function setQuickAlarmFromSettings() {
            const timeInput = document.getElementById('settingsQuickAlarmTime');
            const time = timeInput.value;
            if (!time) return alert('Please select a time');
            
            const alarmId = 'qa_' + Date.now();
            const alarm = { id: alarmId, time: time, label: `Alarm at ${time}` };
            
            quickAlarms.push(alarm);
            localStorage.setItem('quickAlarms', JSON.stringify(quickAlarms));
            timeInput.value = '';
            updateSettingsQuickAlarmsList();
            updateQuickAlarmsList();
        }
        
        function updateSettingsQuickAlarmsList() {
            const container = document.getElementById('settingsQuickAlarmsList');
            if (!container) return;
            
            if (quickAlarms.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:0.8rem;">No quick alarms set</div>';
                return;
            }
            
            container.innerHTML = quickAlarms.map(alarm => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:rgba(0,0,0,0.3); margin:5px 0; border-radius:3px;">
                    <span>üîî ${alarm.time}</span>
                    <button onclick="deleteQuickAlarm('${alarm.id}'); updateSettingsQuickAlarmsList();" style="background:var(--neon-red); color:#000; border:none; padding:4px 8px; cursor:pointer;">√ó</button>
                </div>
            `).join('');
        }
        
        function saveAlarmSoundFromSettings() {
            const select = document.getElementById('settingsAlarmSelect');
            if (select) {
                selectedAlarmSound = select.value;
                localStorage.setItem('selectedAlarmSound', selectedAlarmSound);
                
                // Sync with main alarm selector if it exists
                const mainSelect = document.getElementById('alarmSelect');
                if (mainSelect) {
                    mainSelect.value = selectedAlarmSound;
                }
            }
        }
        
        function toggleScreenWake() {
            screenWakeEnabled = !screenWakeEnabled;
            localStorage.setItem('screenWakeEnabled', screenWakeEnabled);
            const toggle = document.getElementById('screenWakeToggle');
            if (toggle) {
                toggle.checked = screenWakeEnabled;
            }
        }

        // --- NAVIGATION ---
        let currentView = 'alarms';
        
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            const container = document.querySelector('.timeline-container');
            const fab = document.querySelector('.fab-add');
            
            if (view === 'alarms') {
                updateDisplay();
                fab.style.display = 'flex';
            } else if (view === 'stopwatch') {
                container.innerHTML = `
                    <div class="cockpit-stopwatch">
                        <div class="stopwatch-header">
                            <div class="system-status">STOPWATCH MODULE // ACTIVE</div>
                        </div>
                        <div class="stopwatch-display-container">
                            <div class="stopwatch-label">ELAPSED TIME</div>
                            <div class="timer-display stopwatch-timer" id="stopwatch-display">${formatStopwatchTime(stopwatchTime)}</div>
                        </div>
                        <div class="stopwatch-controls">
                            <button onclick="startStopwatch()" id="stopwatch-btn" class="btn-main stopwatch-btn">${stopwatchRunning ? 'PAUSE TIMER' : 'START TIMER'}</button>
                            <button onclick="resetStopwatch()" class="btn-secondary stopwatch-btn">RESET TIMER</button>
                        </div>
                        <div class="stopwatch-grid">
                            <div class="grid-line"></div>
                            <div class="grid-line"></div>
                            <div class="grid-line"></div>
                        </div>
                    </div>
                `;
                fab.style.display = 'none';
            } else if (view === 'settings') {
                container.innerHTML = `
                    <div style="padding:20px;">
                        <h3 style="color:var(--neon-blue); margin-bottom:20px;">SYSTEM SETTINGS</h3>
                        
                        <div style="background:rgba(0,255,255,0.1); padding:15px; margin-bottom:15px; border-left:3px solid var(--neon-blue);">
                            <div style="font-weight:bold; margin-bottom:10px;">‚è∞ QUICK ALARM</div>
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                                <input type="time" id="settingsQuickAlarmTime" style="background:#000; border:1px solid #333; color:#fff; padding:5px; flex:1;">
                                <button onclick="setQuickAlarmFromSettings()" style="background:var(--neon-blue); color:#000; border:none; padding:5px 10px; cursor:pointer; font-weight:bold;">SET</button>
                            </div>
                            <div id="settingsQuickAlarmsList"></div>
                        </div>
                        
                        <div style="background:rgba(0,255,65,0.1); padding:15px; margin-bottom:15px; border-left:3px solid var(--neon-green);">
                            <div style="font-weight:bold; margin-bottom:10px;">üéµ ALARM SOUND</div>
                            <select id="settingsAlarmSelect" onchange="saveAlarmSoundFromSettings()" style="background:#000; border:1px solid #333; color:#fff; padding:8px; width:100%; margin-bottom:10px;">
                                <option value="classic">‚è∞ CLASSIC BELL</option>
                                <option value="digital">üì± DIGITAL BEEP</option>
                                <option value="rooster">üêì ROOSTER</option>
                                <option value="buzzer">‚ö° BUZZER</option>
                                <option value="gentle">üåÖ GENTLE WAKE</option>
                                <option value="urgent">üö® URGENT</option>
                                <option value="chimes">üéµ WIND CHIMES</option>
                                <option value="radio">üìª RADIO STATIC</option>
                                <option value="beeping">üì¢ FAST BEEPING</option>
                                <option value="oldphone">‚òéÔ∏è OLD PHONE</option>
                                <option value="siren">üö® SIREN (ORIGINAL)</option>
                                <option value="beep">üì¢ BEEP (ORIGINAL)</option>
                                <option value="pulse">‚ö° PULSE (ORIGINAL)</option>
                                <option value="horn">üìØ HORN (ORIGINAL)</option>
                                <option value="chime">üîî CHIME (ORIGINAL)</option>
                            </select>
                            <button onclick="testAlarm()" style="background:var(--neon-red); color:#000; border:none; padding:8px 15px; cursor:pointer; width:100%;">TEST ALARM</button>
                        </div>
                        
                        <div style="background:rgba(255,0,60,0.1); padding:15px; margin-bottom:15px; border-left:3px solid var(--neon-red);">
                            <div style="font-weight:bold; margin-bottom:10px;">üì± SCREEN WAKE</div>
                            <div style="color:#888; font-size:0.8rem; margin-bottom:10px;">Turn on screen when alarm rings (uses more battery)</div>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                                <input type="checkbox" id="screenWakeToggle" onchange="toggleScreenWake()" style="transform:scale(1.5);">
                                <span>Wake screen on alarm</span>
                            </label>
                        </div>
                        
                        <div style="background:rgba(20,20,20,0.6); padding:15px; margin-bottom:15px; border-left:3px solid var(--neon-green);">
                            <div style="font-weight:bold; margin-bottom:10px;">üîã BATTERY OPTIMIZATION</div>
                            <div style="color:#888; font-size:0.8rem; margin-bottom:10px;">Disable battery optimization to ensure reliable alarms</div>
                            <button onclick="window.nativeIntegration?.requestBatteryOptimizationWhitelist()" style="background:var(--neon-green); color:#000; border:none; padding:10px 20px; cursor:pointer;">CHECK SETTINGS</button>
                        </div>
                        
                        <div style="background:rgba(20,20,20,0.6); padding:15px; border-left:3px solid var(--neon-blue);">
                            <div style="font-weight:bold; margin-bottom:10px;">üì± PERMISSIONS</div>
                            <div style="color:#888; font-size:0.8rem; margin-bottom:10px;">Grant all permissions for full functionality</div>
                            <button onclick="window.nativeIntegration?.requestPermissions()" style="background:var(--neon-blue); color:#000; border:none; padding:10px 20px; cursor:pointer;">REQUEST PERMISSIONS</button>
                        </div>
                    </div>
                `;
                
                // Sync alarm selector with current setting
                const settingsSelect = document.getElementById('settingsAlarmSelect');
                if (settingsSelect) {
                    settingsSelect.value = selectedAlarmSound;
                }
                
                // Sync screen wake toggle
                const screenWakeToggle = document.getElementById('screenWakeToggle');
                if (screenWakeToggle) {
                    screenWakeToggle.checked = screenWakeEnabled;
                }
                
                // Update quick alarms list in settings
                updateSettingsQuickAlarmsList();
                
                fab.style.display = 'none';
            }
        }
        
        // --- 2. EDITING LOGIC ---
        function openModal(taskId = null) {
            const modal = document.getElementById('addModal');
            const titleInput = document.getElementById('taskTitle');
            const startInput = document.getElementById('taskStart');
            const endInput = document.getElementById('taskEnd');
            const idInput = document.getElementById('editId');

            if (taskId) {
                // EDIT MODE: Find task and fill inputs
                const task = schedule.find(t => t.id === taskId);
                titleInput.value = task.title;
                startInput.value = task.start;
                endInput.value = task.end;
                idInput.value = taskId; // Save ID so we know we are updating
            } else {
                // ADD MODE: Clear inputs
                titleInput.value = '';
                startInput.value = '';
                endInput.value = '';
                idInput.value = ''; // No ID means new task
            }
            modal.style.display = 'flex';
        }

        function closeModal() { document.getElementById('addModal').style.display = 'none'; }

        function saveTask() {
            const id = document.getElementById('editId').value;
            const title = document.getElementById('taskTitle').value;
            const start = document.getElementById('taskStart').value;
            const end = document.getElementById('taskEnd').value;

            if(!title || !start || !end) return alert("MISSING DATA");

            if (id) {
                // UPDATE EXISTING TASK
                const index = schedule.findIndex(t => t.id === id);
                if (index !== -1) {
                    schedule[index] = { id, title, start, end };
                }
            } else {
                // CREATE NEW TASK
                schedule.push({ id: 'task_' + Date.now(), title, start, end });
            }

            // Sort list by time
            schedule.sort((a,b) => window.globalAlarmSystem.parseTime(a.start) - window.globalAlarmSystem.parseTime(b.start));

            // Save to day-specific schedule
            schedules[selectedDay] = schedule;
            localStorage.setItem('userSchedules', JSON.stringify(schedules));
            closeModal();
            updateDisplay();
        }  

        function deleteTask(id) {
            if(confirm("DELETE MISSION?")) {
                schedule = schedule.filter(t => t.id !== id);
                schedules[selectedDay] = schedule;
                localStorage.setItem('userSchedules', JSON.stringify(schedules));
                updateDisplay();
            }
        }

        function resetTemplate() {
            if(confirm("RESET TO FACTORY SETTINGS? This will erase custom schedules for all days.")) {
                schedules = JSON.parse(JSON.stringify(TEMPLATE_SCHEDULES));
                schedule = schedules[selectedDay];
                localStorage.setItem('userSchedules', JSON.stringify(schedules));
                updateDisplay();
            }
        }

        // --- 3. AUDIO ENGINE (Multiple Alarm Sounds) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let currentAlarm = null, silenceOsc = null;
        // Set saved alarm sound on page load (default to classic)
        let selectedAlarmSound = localStorage.getItem('selectedAlarmSound') || 'classic';
        
        // Set saved alarm sound on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('alarmSelect')) {
                document.getElementById('alarmSelect').value = selectedAlarmSound;
            }
        });
        
        // Save alarm sound when changed
        function saveAlarmSound() {
            selectedAlarmSound = document.getElementById('alarmSelect').value;
            localStorage.setItem('selectedAlarmSound', selectedAlarmSound);
        }

        function keepAudioAlive() {
            if(!silenceOsc) {
                silenceOsc = audioCtx.createOscillator();
                const g = audioCtx.createGain(); g.gain.value = 0.0001;
                silenceOsc.connect(g); g.connect(audioCtx.destination);
                silenceOsc.start();
            }
        }

        function createAlarmSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            // Force alarm audio stream (override silent/DND modes)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'üö® HUSTLE OS ALARM',
                    artist: 'System Alert',
                    album: 'Critical Notifications'
                });
            }
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            gain.gain.value = 0.4;
            
            switch(type) {
                case 'classic': // Traditional alarm clock bell
                    osc.type = 'sine';
                    osc.frequency.value = 800;
                    // Create bell-like ringing pattern
                    const bellLfo = audioCtx.createOscillator();
                    bellLfo.type = 'sine';
                    bellLfo.frequency.value = 6; // Ring 6 times per second
                    const bellGain = audioCtx.createGain();
                    bellGain.gain.value = 0.3;
                    bellLfo.connect(bellGain);
                    bellGain.connect(gain.gain);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    bellLfo.start();
                    return { osc, gain, bellLfo };
                    
                case 'digital': // Digital alarm beep
                    osc.type = 'square';
                    osc.frequency.value = 1000;
                    // Create beep pattern: beep-beep-pause
                    gain.gain.setValueAtTime(0, audioCtx.currentTime);
                    for(let i = 0; i < 10; i++) {
                        const time = audioCtx.currentTime + i * 1.5;
                        gain.gain.setValueAtTime(0.5, time);
                        gain.gain.setValueAtTime(0, time + 0.2);
                        gain.gain.setValueAtTime(0.5, time + 0.4);
                        gain.gain.setValueAtTime(0, time + 0.6);
                    }
                    break;
                    
                case 'rooster': // Rooster crow simulation
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.3);
                    osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.8);
                    osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 1.2);
                    gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 1.5);
                    break;
                    
                case 'buzzer': // Electric buzzer
                    osc.type = 'square';
                    osc.frequency.value = 220;
                    const buzzerLfo = audioCtx.createOscillator();
                    buzzerLfo.type = 'square';
                    buzzerLfo.frequency.value = 10;
                    const buzzerGain = audioCtx.createGain();
                    buzzerGain.gain.value = 0.4;
                    buzzerLfo.connect(buzzerGain);
                    buzzerGain.connect(gain.gain);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    buzzerLfo.start();
                    return { osc, gain, buzzerLfo };
                    
                case 'gentle': // Gentle wake up tone
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 2);
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 3);
                    break;
                    
                case 'urgent': // Urgent emergency tone
                    osc.type = 'sawtooth';
                    osc.frequency.value = 800;
                    const urgentLfo = audioCtx.createOscillator();
                    urgentLfo.type = 'square';
                    urgentLfo.frequency.value = 8;
                    const urgentGain = audioCtx.createGain();
                    urgentGain.gain.value = 300;
                    urgentLfo.connect(urgentGain);
                    urgentGain.connect(osc.frequency);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    urgentLfo.start();
                    return { osc, gain, urgentLfo };
                    
                case 'chimes': // Wind chimes
                    osc.type = 'sine';
                    const frequencies = [523, 659, 784, 1047]; // C, E, G, C notes
                    let currentFreq = 0;
                    osc.frequency.value = frequencies[0];
                    
                    // Change frequency every 0.8 seconds
                    const changeFreq = () => {
                        currentFreq = (currentFreq + 1) % frequencies.length;
                        osc.frequency.setValueAtTime(frequencies[currentFreq], audioCtx.currentTime);
                    };
                    const interval = setInterval(changeFreq, 800);
                    
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 0.5);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    return { osc, gain, interval };
                    
                case 'radio': // Radio static/tuning
                    osc.type = 'sawtooth';
                    osc.frequency.value = 1000;
                    const radioLfo = audioCtx.createOscillator();
                    radioLfo.type = 'sine';
                    radioLfo.frequency.value = 3;
                    const radioGain = audioCtx.createGain();
                    radioGain.gain.value = 200;
                    radioLfo.connect(radioGain);
                    radioGain.connect(osc.frequency);
                    
                    // Add some noise
                    const noise = audioCtx.createBufferSource();
                    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < data.length; i++) {
                        data[i] = Math.random() * 0.1;
                    }
                    noise.buffer = buffer;
                    noise.loop = true;
                    noise.connect(gain);
                    
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    radioLfo.start();
                    noise.start();
                    return { osc, gain, radioLfo, noise };
                    
                case 'beeping': // Fast beeping pattern
                    osc.type = 'square';
                    osc.frequency.value = 1200;
                    gain.gain.setValueAtTime(0, audioCtx.currentTime);
                    for(let i = 0; i < 30; i++) {
                        gain.gain.setValueAtTime(0.5, audioCtx.currentTime + i * 0.3);
                        gain.gain.setValueAtTime(0, audioCtx.currentTime + i * 0.3 + 0.1);
                    }
                    break;
                    
                case 'oldphone': // Old telephone ring
                    osc.type = 'sine';
                    osc.frequency.value = 440;
                    const phoneLfo = audioCtx.createOscillator();
                    phoneLfo.type = 'sine';
                    phoneLfo.frequency.value = 2; // Ring pattern
                    const phoneGain = audioCtx.createGain();
                    phoneGain.gain.value = 0.5;
                    phoneLfo.connect(phoneGain);
                    phoneGain.connect(gain.gain);
                    
                    // Add second tone for classic phone ring
                    const osc2 = audioCtx.createOscillator();
                    osc2.type = 'sine';
                    osc2.frequency.value = 480;
                    osc2.connect(gain);
                    
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc2.start();
                    phoneLfo.start();
                    return { osc, gain, phoneLfo, osc2 };
                    
                case 'siren': // Original siren
                    osc.type = 'sawtooth'; osc.frequency.value = 600;
                    const lfo = audioCtx.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 4;
                    const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 200;
                    lfo.connect(lfoGain); lfoGain.connect(osc.frequency);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    lfo.start();
                    return { osc, gain, lfo };
                case 'beep': // Original fast beeping
                    osc.type = 'square'; osc.frequency.value = 800;
                    gain.gain.setValueAtTime(0, audioCtx.currentTime);
                    for(let i = 0; i < 20; i++) {
                        gain.gain.setValueAtTime(0.4, audioCtx.currentTime + i * 0.5);
                        gain.gain.setValueAtTime(0, audioCtx.currentTime + i * 0.5 + 0.2);
                    }
                    break;
                case 'pulse': // Original electronic pulse
                    osc.type = 'triangle'; osc.frequency.value = 440;
                    const pulseLfo = audioCtx.createOscillator(); pulseLfo.type = 'square'; pulseLfo.frequency.value = 8;
                    const pulseGain = audioCtx.createGain(); pulseGain.gain.value = 0.3;
                    pulseLfo.connect(pulseGain); pulseGain.connect(gain.gain);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    pulseLfo.start();
                    return { osc, gain, pulseLfo };
                case 'horn': // Original air horn style
                    osc.type = 'sawtooth'; osc.frequency.value = 300;
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 1);
                    break;
                case 'chime': // Original bell-like chime
                    osc.type = 'sine'; osc.frequency.value = 1000;
                    gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 2);
                    break;
                    
                default: // Fallback to classic
                    osc.type = 'sine';
                    osc.frequency.value = 800;
                    break;
            }
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            return { osc, gain };
        }

        function playSynthAlarm() {
            currentAlarm = createAlarmSound(selectedAlarmSound);
        }
        
        function stopSynthAlarm() { 
            if(currentAlarm) { 
                // Stop main oscillator
                try {
                    currentAlarm.osc.stop(); 
                } catch(e) {}
                
                // Stop any additional oscillators or sources
                if(currentAlarm.osc2) {
                    try { currentAlarm.osc2.stop(); } catch(e) {}
                }
                if(currentAlarm.lfo) {
                    try { currentAlarm.lfo.stop(); } catch(e) {}
                }
                if(currentAlarm.noise) {
                    try { currentAlarm.noise.stop(); } catch(e) {}
                }
                if(currentAlarm.bellLfo) {
                    try { currentAlarm.bellLfo.stop(); } catch(e) {}
                }
                if(currentAlarm.buzzerLfo) {
                    try { currentAlarm.buzzerLfo.stop(); } catch(e) {}
                }
                if(currentAlarm.urgentLfo) {
                    try { currentAlarm.urgentLfo.stop(); } catch(e) {}
                }
                if(currentAlarm.radioLfo) {
                    try { currentAlarm.radioLfo.stop(); } catch(e) {}
                }
                if(currentAlarm.phoneLfo) {
                    try { currentAlarm.phoneLfo.stop(); } catch(e) {}
                }
                if(currentAlarm.pulseLfo) {
                    try { currentAlarm.pulseLfo.stop(); } catch(e) {}
                }
                
                // Clear any intervals
                if(currentAlarm.interval) {
                    clearInterval(currentAlarm.interval);
                }
                
                currentAlarm = null; 
            } 
        }

        // --- 4. CORE ENGINE ---
        let wakeLock = null;
        
        // Initialize system state from global alarm system
        const systemArmed = window.globalAlarmSystem.armed;
        const alarmTriggered = window.globalAlarmSystem.triggered;
        
        // Request notification permission on page load
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission:', permission);
                });
            }
            console.log('Current notification permission:', Notification.permission);
        }
        
        // Enhanced notification function for mobile
        async function sendNotification(title, body) {
            console.log('üîî Attempting notification:', title, body);
            
            // Try native notification first (for mobile app)
            if (window.nativeIntegration && window.nativeIntegration.isNative) {
                try {
                    console.log('üì± Trying native notification...');
                    const success = await window.nativeIntegration.sendSystemAlarm(title, body);
                    if (success) {
                        console.log('‚úÖ Native notification sent');
                        return true;
                    }
                } catch (e) {
                    console.log('‚ùå Native notification failed:', e);
                }
            }
            
            // Try web notification (for browser)
            if ('Notification' in window) {
                // Request permission if needed
                if (Notification.permission === 'default') {
                    console.log('üì± Requesting notification permission...');
                    const permission = await Notification.requestPermission();
                    console.log('üì± Permission result:', permission);
                }
                
                if (Notification.permission === 'granted') {
                    try {
                        console.log('üåê Creating web notification...');
                        const notification = new Notification(title, {
                            body,
                            icon: './favicon-32x32.png',
                            tag: 'hustle-alarm-' + Date.now(),
                            requireInteraction: true,
                            vibrate: [1000, 500, 1000, 500, 1000],
                            silent: false,
                            renotify: true
                        });
                        
                        notification.onclick = () => {
                            window.focus();
                            notification.close();
                        };
                        
                        console.log('‚úÖ Web notification created');
                        return true;
                    } catch (e) {
                        console.log('‚ùå Web notification failed:', e);
                    }
                } else {
                    console.log('‚ùå Notification permission denied');
                }
            }
            
            console.log('‚ö†Ô∏è No notification methods available');
            return false;
        }
        
        async function testAlarm() {
            console.log('üö® Testing alarm system...');
            console.log('System armed:', window.globalAlarmSystem.armed);
            console.log('Alarm triggered:', window.globalAlarmSystem.triggered);
            
            if(!window.globalAlarmSystem.armed) {
                alert('Please arm the system first by clicking INITIALIZE SYSTEM');
                return;
            }
            
            if(window.globalAlarmSystem.triggered) {
                alert('Alarm already active! Please silence it first.');
                return;
            }
            
            // Force trigger alarm using global system
            await window.globalAlarmSystem.triggerAlarm('TEST ALARM');
        }

        function parseTime(t) { const [h,m] = t.split(':').map(Number); return h*60+m; }
        
        function getCurrentMinutes() { const d = new Date(); return d.getHours()*60 + d.getMinutes(); }

        function findCurrentTask() {
            // 1. Get current time
            const now = getCurrentMinutes();
            let validCandidates = [];

            // 2. Find ALL tasks that are currently active
            for(let t of schedule) {
                let s = parseTime(t.start);
                let e = parseTime(t.end);
                
                // Handle Midnight (e.g., 23:00 to 01:00)
                if(e < s) e += 1440; 
                
                // Handle "Now" being late night (e.g., it's 00:30, task started 23:00)
                let n = now;
                if(n < s && s > 1200) n += 1440; 

                // Check if we are inside this task
                if(n >= s && n < e) {
                    // Save the task AND its length (duration)
                    validCandidates.push({ task: t, duration: e - s });
                }
            }

            // 3. Logic: Return both shortest and longest
            if(validCandidates.length === 0) {
                return { main: { title: "IDLE MODE", start: "00:00", end: "00:00" }, mini: null };
            }

            // Sort by DURATION (Smallest first)
            validCandidates.sort((a, b) => a.duration - b.duration);

            if(validCandidates.length === 1) {
                return { main: validCandidates[0].task, mini: null };
            } else {
                // Multiple tasks: shortest goes to mini, longest goes to main
                return { 
                    mini: validCandidates[0].task, 
                    main: validCandidates[validCandidates.length - 1].task 
                };
            }
        }

        function getSecondsLeft(endStr) {
            if(endStr === "00:00") return 0;
            const d = new Date();
            const [h,m] = endStr.split(':').map(Number);
            let target = new Date(d); target.setHours(h,m,0,0);
            if(target < d) target.setDate(target.getDate()+1);
            return Math.floor((target - d)/1000);
        }

        async function handleSystemClick() {
            if (!window.globalAlarmSystem.armed) {
                audioCtx.resume().then(() => { keepAudioAlive(); });
                window.globalAlarmSystem.armed = true;
                localStorage.setItem('systemArmed', 'true');
                document.getElementById('main-btn').innerText = "SYSTEM ARMED";
                document.getElementById('main-btn').style.background = "rgba(0,255,65,0.1)";
                
                // Initialize native features
                await window.nativeIntegration.initialize();
                await window.nativeIntegration.keepScreenAwake();
                
                // Enhanced screen wake lock
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Screen wake lock activated');
                    }
                } catch (err) {
                    console.log('Wake lock failed:', err);
                }
                
                // Check battery optimization
                const isOptimized = await window.nativeIntegration.checkBatteryOptimization();
                if (!isOptimized) {
                    if (confirm('Allow HustleOS to ignore battery optimization for reliable alarms?')) {
                        await window.nativeIntegration.requestBatteryOptimizationWhitelist();
                    }
                }
            } else if (window.globalAlarmSystem.triggered) {
                window.globalAlarmSystem.silenceAlarm();
            }
        }

        async function updateDisplay() {
            // Only update if we're on the alarms view
            if (currentView !== 'alarms') return;
            
            // Update day selector
            const daySelect = document.getElementById('daySelect');
            if (daySelect) {
                daySelect.value = selectedDay;
            }
            
            // Get tasks for selected day
            const tasks = window.globalAlarmSystem.findCurrentTask(schedule);
            const mainTask = tasks.main;
            const miniTask = tasks.mini;
            
            // Update main task display
            const sec = window.globalAlarmSystem.getSecondsLeft(mainTask.end);
            document.querySelector('.current-mission').innerText = mainTask.title;
            const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
            document.querySelector('.timer-display').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            // Update mini task display
            const miniCard = document.getElementById('mini-task');
            if(miniTask) {
                const miniSec = window.globalAlarmSystem.getSecondsLeft(miniTask.end);
                const miniH = Math.floor(miniSec/3600), miniM = Math.floor((miniSec%3600)/60), miniS = miniSec%60;
                
                document.getElementById('mini-task-title').innerText = miniTask.title;
                document.getElementById('mini-task-timer').innerText = `${String(miniH).padStart(2,'0')}:${String(miniM).padStart(2,'0')}:${String(miniS).padStart(2,'0')}`;
                miniCard.style.display = 'block';
            } else {
                miniCard.style.display = 'none';
            }

            // RENDER LIST (Sort pinned tasks first)
            const container = document.querySelector('.timeline-container');
            container.innerHTML = ''; 
            
            const sortedSchedule = [...schedule].sort((a, b) => {
                const aPinned = pinnedTasks.includes(a.id);
                const bPinned = pinnedTasks.includes(b.id);
                if (aPinned && !bPinned) return -1;
                if (!aPinned && bPinned) return 1;
                return window.globalAlarmSystem.parseTime(a.start) - window.globalAlarmSystem.parseTime(b.start);
            });
            
            sortedSchedule.forEach(t => {
                const active = (t.id === mainTask.id) || (miniTask && t.id === miniTask.id);
                const pinned = pinnedTasks.includes(t.id);
                const div = document.createElement('div');
                div.className = `task-card ${active ? 'active' : ''}`;
                div.style.background = pinned ? 'rgba(0,255,65,0.1)' : 'rgba(20,20,20,0.6)';
                div.onclick = () => openModal(t.id);
                div.innerHTML = `
                    <div>
                        <div style="font-size:0.8rem; color:#777; font-weight:bold;">${pinned ? 'üìå ' : ''}${t.start} - ${t.end}</div>
                        <div style="font-size:1rem; font-weight:bold; color:#ddd;">${t.title}</div>
                    </div>
                    <div class="card-actions">
                        <button class="action-icon" onclick="event.stopPropagation(); togglePin('${t.id}')" style="color:${pinned ? 'var(--neon-green)' : '#666'};">üìå</button>
                        <button class="action-icon btn-edit" onclick="event.stopPropagation(); openModal('${t.id}')">‚úé</button>
                        <button class="action-icon btn-del" onclick="event.stopPropagation(); deleteTask('${t.id}')">√ó</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        setInterval(updateDisplay, 1000);
        updateDisplay();
        updateQuickAlarmsList();
        
        // Keep screen awake when system is armed
        document.addEventListener('visibilitychange', async () => {
            if (systemArmed && document.visibilityState === 'visible') {
                try {
                    if ('wakeLock' in navigator && !wakeLock) {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) {
                    console.log('Wake lock reactivation failed:', err);
                }
            }
        });
        
        // Initialize button state on page load
        if(window.globalAlarmSystem.armed) {
            const btn = document.getElementById('main-btn');
            if (btn) {
                btn.innerText = "SYSTEM ARMED";
                btn.style.background = "rgba(0,255,65,0.1)";
            }
        }
        
        // Register service worker for PWA with auto-update
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New update available, reload page
                            console.log('üîÑ New version available, reloading...');
                            window.location.reload();
                        }
                    });
                });
            });
        }
    </script>
</body>
</html>
